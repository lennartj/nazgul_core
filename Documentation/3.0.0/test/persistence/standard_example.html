<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.7.4 at 2017-04-22 
 | Rendered using Apache Maven Fluido Skin 1.6
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20170422" />
    <meta http-equiv="Content-Language" content="en" />
    <title>nazgul-core-persistence-test &#x2013; Example: Automated persistence tests</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-1.6.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />
      <script type="text/javascript" src="./js/apache-maven-fluido-1.6.min.js"></script>
<!-- Add syntax highlighter -->
            <link href="http://alexgorbatchev.com/pub/sh/current/styles/shThemeDefault.css"
                  rel="stylesheet"
                  type="text/css"/>
            <link href="http://alexgorbatchev.com/pub/sh/current/styles/shCore.css"
                  rel="stylesheet"
                  type="text/css"/>
            <script src="http://alexgorbatchev.com/pub/sh/current/scripts/shCore.js"
                    type="text/javascript"></script>
            <script src="http://alexgorbatchev.com/pub/sh/current/scripts/shBrushJava.js"
                    type="text/javascript"></script>
            <script src="http://alexgorbatchev.com/pub/sh/current/scripts/shBrushJScript.js"
                    type="text/javascript"></script>
            <script src="http://alexgorbatchev.com/pub/sh/current/scripts/shBrushXml.js"
                    type="text/javascript"></script>
      </head>
    <body class="topBarDisabled">
      <div class="container-fluid">
      <div id="banner">
        <div class="pull-left"><div id="bannerLeft"><h2><span style="color: #777777;">nazgul-core-persistence-test</span></h2>
</div>
</div>
        <div class="pull-right"><div id="bannerRight"><h2>Nazgul Framework: Core</h2>
</div>
</div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
        <li id="projectVersion">Version: 3.0.0</li>
        <li id="publishDate" class="pull-right"><span class="divider">|</span> Last Published: 2017-04-22</li>
      <li class="pull-right"><span class="divider">|</span>
<a href="http://bitbucket.org/lennartj" class="externalLink" title="Bitbucket">Bitbucket</a></li>
      <li class="pull-right"><a href="http://maven.apache.org/" class="externalLink" title="Maven">Maven</a></li>
        </ul>
      </div>
      <div class="row-fluid">
        <div id="leftColumn" class="span2">
          <div class="well sidebar-nav">
<ul class="nav nav-list">
          <li class="nav-header">Overview</li>
    <li><a href="index.html" title="Introduction"><span class="none"></span>Introduction</a>  </li>
    <li class="active"><a href="#"><span class="none"></span>Example: StandardPersistenceTest</a>
  </li>
    <li><a href="approaches.html" title="Approaches"><span class="none"></span>Approaches</a>  </li>
          <li class="nav-header">Parent Project</li>
    <li><a href="../../core/poms/core-model-parent/index.html" title="nazgul-core-model-parent"><span class="none"></span>nazgul-core-model-parent</a>  </li>
                              <li class="nav-header">Project Documentation</li>
    <li><a href="project-info.html" title="Project Information"><span class="icon-chevron-right"></span>Project Information</a>  </li>
    <li><a href="project-reports.html" title="Project Reports"><span class="icon-chevron-right"></span>Project Reports</a>  </li>
  </ul>
          <hr />
          <div id="poweredBy">
              <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
  <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy"><img class="builtBy" alt="Built by Maven" src="./images/logos/maven-feather.png" /></a>
              </div>
          </div>
        </div>
        <div id="bodyColumn"  class="span10" >
<h1>Example: Automated persistence tests</h1>
<p>The simplest way to create automated persistence tests is to subclass the superclass <tt>StandardPersistenceTest</tt>, which hides most of the complexity of the required lifecycle. The 6 steps to automated tests using the Nazgul Core: Persistence Test framework are:</p>

<ol style="list-style-type: decimal">
  
<li>Create an entity class with JPA annotations.</li>
  
<li>Subclass StandardPersistenceTest to create your own automated test class.</li>
  
<li>Create a test-scope <tt>persistence.xml</tt> within the test&#x2019;s associated resource directory.</li>
  
<li>Create test methods in your automated test class.</li>
  
<li>For each test method, create <tt>setup_(methodName).xml</tt> and <tt>expected_(methodName).xml</tt>  containing the setup and expected data (respectively) for the unit test database.</li>
  
<li>Add transaction handling method calls as required.</li>
  
<li>Validate database data</li>
  
<li>Run and enjoy!</li>
</ol>
<p>Each subsection of the page below will illustrate one of these steps.</p>
<div class="section">
<div class="section">
<h3><a name="a1_Create_an_entity_class_with_JPA_annotations:_Bird"></a>1) Create an entity class with JPA annotations: Bird</h3>
<p>The Bird class must be JPA-annotated to be usable by an EntityManager; the annotated parts are found in the snippet below. Note that the Bird class extends <tt>NazgulEntity</tt>, which holds the identity and version fields required by the JPA specification. The NazgulEntity class also supplies other services and simplifications, (for instance, cloning and automatic validation) implying that Entity classes extending it - such as Bird - can focus on the business model instead of the JPA-mandated infrastructure.</p>

<div>
<pre class="brush: java" title="JPA-annotated entity class snippet.">
    @Entity
    public class Bird extends NazgulEntity {
    
        @Basic(optional = false)
        @Column(nullable = false, length = 64)
        private String name;
    
        @Basic(optional = false)
        @Column(nullable = false, length = 128)
        private String category;
        
        ...
    }
</pre></div>
<p>In the code snippet above, only the JPA-annotated bits of the class are shown. All setters/getters/constructors and nifty bits such as NamedQueries are left out for the sake of brevity.</p></div></div>
<div class="section">
<h2><a name="a2_Subclass_StandardPersistenceTest:"></a>2) Subclass StandardPersistenceTest:</h2>
<p>Simply extend the StandardPersistenceTest class to create your own class, as shown in the code snippet below. It is recommended to use a better name than the example below to preserve your good mood and temper:</p>

<div>
<pre class="brush: java" title="Example persistence test method: validateCreateEntity()">
public class MockStandardPersistenceTest extends StandardPersistenceTest {

    ...
}
</pre></div></div>
<div class="section">
<h2><a name="a3_Create_a_test-scope_persistence.xml_in_the_associated_resource_directory."></a>3) Create a test-scope <tt>persistence.xml</tt> in the associated resource directory.</h2>
<p>The StandardPersistenceTest class expects to find a persistence.xml file in a well-known location, namely a directory found under <tt>src/main/resources/testdata/(className)</tt>. Given that our example test class is called <tt>MockStandardPersistenceTest</tt> the associated directory is <tt>src/main/resources/testdata/MockStandardPersistenceTest</tt>, relative to the project basedir. The placement of the persistence.xml is shown in the image below (the other files shown will be discussed shortly):</p>
<p><img src="images/associatedResourceDirectory.png" style="margin:10px; border:1px solid black;" width="50%" height="50%" alt="" /></p>
<p>The persistence.xml file should have the following content:</p>

<div>
<pre class="brush: xml" title="persistence.xml example">
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;persistence version=&quot;2.1&quot;
             xmlns=&quot;http://xmlns.jcp.org/xml/ns/persistence&quot;
             xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
             xsi:schemaLocation=&quot;http://xmlns.jcp.org/xml/ns/persistence http://xmlns.jcp.org/xml/ns/persistence/persistence_2_1.xsd&quot;&gt;

    &lt;persistence-unit name=&quot;InMemoryTestPU&quot;&gt;

        &lt;class&gt;se.jguru.nazgul.core.persistence.model.NazgulEntity&lt;/class&gt;
        &lt;class&gt;se.jguru.nazgul.test.persistence.pets.Bird&lt;/class&gt;
        &lt;class&gt;se.jguru.nazgul.test.persistence.pets.Seed&lt;/class&gt;

        &lt;!--
            When set to true then only listed classes and jars will
            be scanned for persistent classes, otherwise the enclosing
            jar or directory will also be scanned. Not applicable to
            Java SE persistence units.
        --&gt;
        &lt;exclude-unlisted-classes&gt;false&lt;/exclude-unlisted-classes&gt;

    &lt;/persistence-unit&gt;
&lt;/persistence&gt;
        
</pre></div>
<p>Some points regarding the persistence.xml content are worth noting:</p>

<ol style="list-style-type: decimal">
  
<li>The persistence version attribute should have the value 2.1 to yield JPA 2.1 behaviour</li>
  
<li>The name of the persistence unit should always be <tt>InMemoryTestPU</tt></li>
  
<li>Always add <tt>se.jguru.nazgul.core.persistence.model.NazgulEntity</tt> to the list of persisted classes.  Also, remember to add all classes you want to use in your JPA persistence unit.  Since all tests execute in test scope, you are free to add JPA-annotated test-scope classes  to the persistence unit.</li>
  
<li>You do not need to add traditional persistence properties (JDBC Driver etc).  This is done automatically by the framework to keep the amount of required boilerplate  configuration properties down to a minimum.</li>
</ol>
<p>Now you have created the configuration required by JPA. </p>
<div class="section">
<div class="section">
<h4><a name="a3.1_Technical_background:_Creating_database_tables"></a>3.1) <i>Technical background:</i> Creating database tables</h4>
<p>The StandardPersistenceTest uses a custom ClassLoader to ensure that we can use a persistence.xml file placed within the classpath - but not the standard <tt>META-INF/persistence.xml</tt>, but instead <tt>&quot;testdata/&quot; + getClass().getSimpleName() + &quot;/persistence.xml&quot;</tt> as shown above. The persistence.xml file is shared for all test methods within a test class - if you want/need to use another persistence.xml, simply create a new unit test class.</p>
<p>One of the nice things about JPA is that providers can use annotated Entity classes to create the database tables in an empty database schema. After connecting to the database (but before populating the database with initial state data) the JPA provider uses all annotated JPA classes known to the PersistenceUnit to create database tables as required for the automated test. Therefore, the database structure is always compatible with the annotated entity classes. </p></div></div></div>
<div class="section">
<h2><a name="a4_Create_test_methods_in_your_automated_test_class."></a>4) Create test methods in your automated test class.</h2>
<p>Let&#x2019;s start with a typical test method that uses the mechanics of the persistence test component. In this case, we use a JPA-annotated class to create a new row in a database table (each table row normally corresponds to an Entity object, remember):</p>

<div>
<pre class="brush: java" title="Example persistence test method: validateCreateEntity()">
    @Test
    public void validateCreateEntity() throws Exception {

        // Assemble
        final Bird eagle = new Bird(&quot;Eagle&quot;, &quot;Predator&quot;);
        final IDataSet expected = performStandardTestDbSetup();

        // Act
        jpa.create(eagle);
        commitAndStartNewTransaction();

        // Assert
        final List&lt;Bird&gt; birds = jpa.fireNamedQuery(Bird.GET_ALL_BIRDS);
        final IDataSet dbDataSet = iDatabaseConnection.createDataSet(new String[]{&quot;BIRD&quot;});
        
        Assert.assertEquals(2, birds.size());
        Assertion.assertEquals(expected, dbDataSet);
    }
</pre></div>
<p>Creating the entity in the database is done by the <tt>jpa.create(eagle);</tt> statement. This method - in turn - is a thin wrapper invokes the standard EntityManager method <tt>entityManager.persist(entity);</tt> which persists the Bird object in the database. Essentially, the create statement performs all which should be validated within the test. The rest of the statements in the test method either sets up the data within the database or validates what is stored in the database.</p>
<p>Note that the EntityManager is somewhat hidden within the object referenced by the variable <tt>jpa</tt>. This is an JpaTestPersistenceOperations object, which serves to simplify best practises and shield the EntityManager from potentially problematic operations in test scope. </p>
<div class="section">
<h3><a name="a5_Managing_database_data:_performStandardTestDbSetup"></a>5) Managing database data: <tt>performStandardTestDbSetup()</tt></h3>
<p>Databases must normally be pre-populate with a known state before firing JPA operations, in order to ascertain that the annotated entity classes, validators and other tidbits are correctly implemented. The operation which populates a database with initial state data is <tt>performStandardTestDbSetup()</tt>. </p>
<p>This method connects to the (in-memory) database used by the test-scope JPA EntityManager, and uses a configuration file to insert a well-known state into it. The value returned from the <tt>performStandardTestDbSetup()</tt> method contains the state expected within the database after running the tests (hence called <tt>expected</tt>):</p>

<div>
<pre class="brush: java" title="Setup database state method">
    @Test
    public void validateCreateEntity() throws Exception {

        // Assemble
        ...
        final IDataSet expected = performStandardTestDbSetup();
</pre></div>
<p>The path to the configuration file for the database setup is calculated from the name of the test class and the test method, on the standard form <tt>&quot;testdata/&quot; + getClass().getSimpleName() + &quot;/setup_&quot; + testMethodName + &quot;.xml&quot;</tt>. Illustrated in the image below, this leads to a structure under the testdata resource map where all setup and teardown data files are created in pairs, which yields a rather clean and obvious structure. As illustrated in the image below, the 3 test methods in class <tt>JpaRelationsTest</tt> for which we want to setup and validate database state are &#x201c;validateCreateJpaRelationEntities&#x201d;, &#x201c;validateDeleteEntity&#x201d; and &#x201c;validateUpdateEntity&#x201d;:</p>
<p><img src="images/associatedResourceDirectory.png" style="margin:10px; border:1px solid black;" width="50%" height="50%" alt="" /></p>
<p>The &#x201c;setup<i>&#x201c; and &#x201d;expected</i>&#x201d; XML files contains standard <a class="externalLink" href="http://dbunit.sourceforge.net/">dbUnit</a> XML data instructions, which are used as templates to insert data into the database or verify data within the database respectively. Since the test aims at creating an entity, we need no previous content in the database.<br />However, just to illustrate that we need not start a unit test with an empty database, the content of the setup_validateCreateEntity.xml file contains the insertion of a row within the <tt>bird</tt> table:</p>

<div>
<pre class="brush: xml">
    &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
    &lt;dataset&gt;
        &lt;BIRD id=&quot;1&quot; version=&quot;1&quot; name=&quot;Hawk&quot; category=&quot;Predator&quot; /&gt;
    &lt;/dataset&gt;
        
</pre></div>
<p>This implies that we populate the database with some data before the automated test is started. For further reference to the dataset structure, please refer to the <a class="externalLink" href="http://dbunit.sourceforge.net/">dbUnit</a> website. </p></div>
<div class="section">
<h3><a name="a6_Add_transaction_handling_method_calls_as_required"></a>6) Add transaction handling method calls as required</h3>
<p>Frequently in JEE setups, the application server controls the transaction manager (known as Container-Managed Persistence, or CMP) implying that the developer can avoid mixing business logic and transaction management. This can both be a blessing and a curse depending on the scenario, the developer&#x2019;s experience and the required level of control. However, in a JPA persistence test-scope scenario we should be able to manually control when to commit or rollback the transaction.</p>
<p>The Nazgul Core: Persistence Test approaches the transaction management in a simple way; the developer typically wants to do one of four things:</p>

<table border="0" class="table table-striped">
    
<tr class="a">
        
<th width="25%">Method</th>
        
<th width="75%">Description</th>
    </tr>
    
<tr class="b">
        
<td>commitAndStartNewTransaction(); or commit(true);</td>
        
<td>Commit the active transaction, flush the JPA state to the database and create a new EntityTransaction 
            for further JPA operations. (A &quot;Write the changes to the database&quot; operation).</td>
    </tr>
    
<tr class="a">
        
<td>commit(false);</td>
        
<td>Commit the active transaction, flush the JPA state to the database and creates a new EntityTransaction 
            for further JPA operations. However, the newly created EntityTransaction is not started 
            (using `begin()`).</td>
    </tr>
    
<tr class="b">
         
<td>rollbackAndStartNewTransaction(); or rollback(true);</td>
         
<td>Rolls the active transaction back, flush the JPA state to the database and create a new, started 
             EntityTransaction for further JPA operations. (An &quot;Abandon the changes to the database&quot; operation).</td>
    </tr>
    
<tr class="a">
        
<td>rollback(false);</td>
        
<td>Commit the active transaction, flush the JPA state to the database and create a new EntityTransaction 
            for further JPA operations. However, the newly created EntityTransaction is not started 
            (using `begin()`) (An &quot;Abandon the changes to the database&quot; operation).</td>
    </tr>
</table>
<p>By exposing these four methods, we can provide a simple entry to the EntityTransaction so developers can control and access database states which can be rather difficult to induce within a running JEE application server.</p></div>
<div class="section">
<h3><a name="a7_Validating_database_statedata"></a>7) Validating database state/data</h3>
<p>When your automatic JPA tests have used Entities to perform some kind of change in the database, you would want to validate the changes done. In this case - just like in the setup phase - we use the <a class="externalLink" href="http://dbunit.sourceforge.net/">dbUnit</a> standard framework. <a class="externalLink" href="http://dbunit.sourceforge.net/">dbUnit</a> has a simple and database-independent way to represent table structures and data within them, and works well with the <a class="externalLink" href="http://junit.org/">jUnit test framework</a>.</p>
<p>The standard way to validate database state has 3 parts: </p>
<p>1) Reading the expected state (in the database) from a dbUnit configuration file.  This is done by <tt>performStandardTestDbSetup()</tt> method and delivered as its return value. 2) Reading the actual state from the database, which is done by a standard dbUnit method called  <tt>createDataSet()</tt>. The StandardPersistenceTest class ensures that the iDatabaseConnection variable  always points to the active in-memory database used by the JPA engine. 3) Comparing the expected and actual states is done with the standard dbUnit method  <tt>Assertion.assertEquals(expected, dbDataSet2);</tt>. </p>
<p>This is all shown in the code snippet below:</p>

<div>
<pre class="brush: java" title="Validate database state method">
    @Test
    public void validateCreateEntity() throws Exception {

        // Assemble
        ...
        final IDataSet expected = performStandardTestDbSetup();
        
        ...
        
        // Assert
        final IDataSet dbDataSet = iDatabaseConnection.createDataSet(new String[]{&quot;BIRD&quot;});
        Assertion.assertEquals(expected, dbDataSet);
</pre></div>
<p>To further simplify validating database state, the Nazgul Core: Persistence Test framework employ a dbUnit configuration file with the path <tt>&quot;testdata/&quot; + getClass().getSimpleName() + &quot;/expected_&quot; + testMethodName + &quot;.xml&quot;</tt>, as illustrated in the image below:</p>
<p><img src="images/dbPopulationConfiguration.png" style="margin:10px; border:1px solid black;" width="50%" height="50%" alt="" /></p>
<p>The content of the expected dbUnit XML file is:</p>

<div>
<pre class="brush: xml">
    &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
    &lt;dataset&gt;
    &lt;/dataset&gt;
        
</pre></div></div>
<div class="section">
<h3><a name="a8_Run_and_enjoy"></a>8) Run and enjoy!</h3>
<p>These steps are really all you should need to walk through in order to verify your JPA-annotated entities using the Nazgul Core: Persistence Test framework. However, usability hint could be of use:</p>
<div class="section">
<h4><a name="Extracting_database_state"></a>Extracting database state</h4>
<p>To extract database state at some point in the test, simply use the convenience method <tt>extractFlatXmlDataSet</tt>:</p>

<div>
<pre class="brush: java">
        // Get the data from the database
        final IDataSet dbDataSet2 = iDatabaseConnection.createDataSet();
        
        // Simply print out the dbUnit-compliant XML for the given data state
        System.out.println(&quot;Got: &quot; + extractFlatXmlDataSet(dbDataSet2));
</pre></div></div></div></div>
        </div>
      </div>
    </div>
    <hr/>
    <footer>
      <div class="container-fluid">
        <div class="row-fluid">
<!-- Launch the syntax highlighter. -->
            <script type="text/javascript">
                SyntaxHighlighter.all()
            </script>
        </div>
        </div>
    </footer>
    </body>
</html>
