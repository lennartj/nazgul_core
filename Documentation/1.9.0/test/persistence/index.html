<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia at 2016-07-01 
 | Rendered using Apache Maven Fluido Skin 1.4
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20160701" />
    <meta http-equiv="Content-Language" content="en" />
    <title>nazgul-core-persistence-test &#x2013; Nazgul Core: Persistence Test</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-1.4.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />

      
    <script type="text/javascript" src="./js/apache-maven-fluido-1.4.min.js"></script>

                          
        
<link rel="stylesheet" href="http://alexgorbatchev.com/pub/sh/current/styles/shThemeDefault.css" type="text/css"/>
                      
        
<link rel="stylesheet" href="http://alexgorbatchev.com/pub/sh/current/styles/shCore.css" type="text/css"/>
                      
        
<script src="http://alexgorbatchev.com/pub/sh/current/scripts/shCore.js" type="text/javascript"></script>
                      
        
<script src="http://alexgorbatchev.com/pub/sh/current/scripts/shBrushJava.js" type="text/javascript"></script>
                      
        
<script src="http://alexgorbatchev.com/pub/sh/current/scripts/shBrushJScript.js" type="text/javascript"></script>
                      
        
<script src="http://alexgorbatchev.com/pub/sh/current/scripts/shBrushXml.js" type="text/javascript"></script>
          
                  </head>
        <body class="topBarDisabled">
          
                
                    
    
        <div class="container-fluid">
          <div id="banner">
        <div class="pull-left">
                                <div id="bannerLeft">
                <h2><span style="color: #777777;">nazgul-core-persistence-test</span></h2>
                </div>
                      </div>
        <div class="pull-right">              <div id="bannerRight">
                <h2>Nazgul Framework: Core</h2>
                </div>
      </div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
                
                    
                  <li id="projectVersion">Version: 1.9.0
                    </li>
              
                
                    
                  <li id="publishDate" class="pull-right"><span class="divider">|</span> Last Published: 2016-07-01</li>
            
                                    
    <li class="pull-right">
        <span class="divider">|</span>
                      <a href="http://bitbucket.org/lennartj" class="externalLink" title="Bitbucket">
        Bitbucket</a>
      </li>

  
    <li class="pull-right">
                      <a href="http://maven.apache.org/" class="externalLink" title="Maven">
        Maven</a>
      </li>

                    </ul>
      </div>

            
      <div class="row-fluid">
        <div id="leftColumn" class="span2">
          <div class="well sidebar-nav">
                
                    
                <ul class="nav nav-list">
                    <li class="nav-header">Overview</li>
                              
      <li class="active">
  
            <a href="#"><span class="none"></span>Introduction</a>
          </li>
                
      <li>
  
                          <a href="standard_example.html" title="Example: StandardPersistenceTest">
          <span class="none"></span>
        Example: StandardPersistenceTest</a>
            </li>
                
      <li>
  
                          <a href="approaches.html" title="Approaches">
          <span class="none"></span>
        Approaches</a>
            </li>
                              <li class="nav-header">Parent Project</li>
                              
      <li>
  
                          <a href="../../core/poms/core-model-parent/index.html" title="nazgul-core-model-parent">
          <span class="none"></span>
        nazgul-core-model-parent</a>
            </li>
                                                                                                    <li class="nav-header">Project Documentation</li>
                                                                                                                                                                                                                                                                                      
      <li>
  
                          <a href="project-info.html" title="Project Information">
          <span class="icon-chevron-right"></span>
        Project Information</a>
                  </li>
                                                                                                                                                                                                                                                                
      <li>
  
                          <a href="project-reports.html" title="Project Reports">
          <span class="icon-chevron-down"></span>
        Project Reports</a>
                    <ul class="nav nav-list">
                    
      <li class="active">
  
            <a href="#"><span class="none"></span>AspectJ Report</a>
          </li>
                    
      <li>
  
                          <a href="apidocs/index.html" title="JavaDocs">
          <span class="none"></span>
        JavaDocs</a>
            </li>
                    
      <li>
  
                          <a href="testapidocs/index.html" title="Test JavaDocs">
          <span class="none"></span>
        Test JavaDocs</a>
            </li>
                    
      <li>
  
                          <a href="xref/index.html" title="Source Xref">
          <span class="none"></span>
        Source Xref</a>
            </li>
                    
      <li>
  
                          <a href="xref-test/index.html" title="Test Source Xref">
          <span class="none"></span>
        Test Source Xref</a>
            </li>
                    
      <li>
  
                          <a href="cobertura/index.html" title="Cobertura Test Coverage">
          <span class="none"></span>
        Cobertura Test Coverage</a>
            </li>
                    
      <li>
  
                          <a href="findbugs.html" title="FindBugs">
          <span class="none"></span>
        FindBugs</a>
            </li>
                    
      <li>
  
                          <a href="clirr-report.html" title="Clirr">
          <span class="none"></span>
        Clirr</a>
            </li>
                    
      <li>
  
                          <a href="property-updates-report.html" title="Property Updates Report">
          <span class="none"></span>
        Property Updates Report</a>
            </li>
                    
      <li>
  
                          <a href="dependency-updates-report.html" title="Dependency Updates Report">
          <span class="none"></span>
        Dependency Updates Report</a>
            </li>
                    
      <li>
  
                          <a href="plugin-updates-report.html" title="Plugin Updates Report">
          <span class="none"></span>
        Plugin Updates Report</a>
            </li>
              </ul>
        </li>
            </ul>
                
                    
                
          <hr />

           <div id="poweredBy">
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="builtBy" alt="Built by Maven" src="./images/logos/maven-feather.png" />
      </a>
                  </div>
          </div>
        </div>
        
                
        <div id="bodyColumn"  class="span10" >
                                  
            <h1>Nazgul Core: Persistence Test</h1>
<p>The Java persistence API (JPA) is a great asset for creating entities that communicate with a (relational) database to read and write their state to persistent storage. The Nazgul Core: Persistence test project provides a suite of classes which simplifies creating automated tests for JPA-annotated entities.</p>
<p>JPA-annotated entity classes typically need some extra scaffolding to meaningfully participate in an automated test. We all want to validate that our entities work correctly - and connecting the JPA provider to a real (but small) database it is frequently really helpful to discover the specifics of how your JPA annotations affect the physical model. It would also be really good to validate the behaviour in a standard unit test setting.</p>
<div class="section">
<div class="section">
<h3><a name="Unit_tests_or_integration_tests"></a>Unit tests or integration tests?</h3>
<p>In a textbook sense, the Nazgul Core: Persistence test project provides scaffolding to simplify running automated <b>integration</b> tests, as the database is not mocked (which is the traditional approach by <b>unit</b> tests) but instead an in-memory database created and populated before the tests are started. At the same time, it is difficult to run meaningful tests on Model entities when mocking the entire JPA framework since the (JPA) provider certainly plays an important role in any system where it is used.</p></div></div>
<div class="section">
<h2><a name="StandardPersistenceTest_lifecycle"></a>StandardPersistenceTest lifecycle</h2>
<p>The StandardPersistenceTest, from which you should normally derive/extend your automated test classes, achieves the persistence test structure using a standard setup/test/teardown lifecycle as shown in the image below. </p>
<p><img src="images/plantuml/0_overview.png" style="margin:10px; border:1px solid black;" alt="" /></p></div>
<div class="section">
<h2><a name="StandardPeristenceTest_lifecycle_tasks"></a>StandardPeristenceTest lifecycle tasks</h2>
<p>In somewhat more detail, the StandardPersistenceTest lifecycle consists of 10 steps. These steps are illustrated in the image below and described in the list following it.</p>
<p><img src="images/plantuml/1_test_tasks_overview.png" style="margin:10px; border:1px solid black;" alt="" /></p>

<ol style="list-style-type: decimal">
  
<li>An in-memory database (typically hsqldb) is created.</li>
  
<li>The JPA EntityManager loads definitions and class information from a test-class-specific  <tt>persistence.xml</tt> and creates the database tables from the annotated JPA classes defined within it.</li>
  
<li>The actual test starts; <a class="externalLink" href="http://dbunit.sourceforge.net/">dbUnit</a> reads a <tt>setup_[testMethodName].xml</tt> file to  populate the tables within the in-memory database with a well-known state.</li>
  
<li><a class="externalLink" href="http://dbunit.sourceforge.net/">dbUnit</a> reads an <tt>expected_[testMethodName].xml</tt> file  to find an expected database state, typically what should be expected after the test completes.</li>
  
<li>The test normally <tt>begin()</tt>s an EntityTransaction, since JPA operations frequently needs to execute within  a transaction.</li>
  
<li>The actual JPA test methods can be fired at will against the database. At this stage in the test, both  or either of JPA and dbUnit connections can be used to access the database. However, it is recommended that  only JPA be used to manipulate (table) row data.</li>
  
<li>Since JPA providers normally do not write data to the database before the active EntityTransaction is  <tt>commit()</tt>ted, we should now perform a commit (or rollback, depending on the needs of the test). This  flushes the JPA provider&#x2019;s cache and writes any data to the database tables.</li>
  
<li>Following committing the active transaction, we should now validate the database state. The recommended  approach is to use dbUnit to &#x201c;see&#x201d; directly into the actual database state (implying that any JPA provider  cache state will not hide real database table data).</li>
  
<li>The Connections to the in-memory database (both JPA/EntityManager and dbUnit/iConnection) are closed.</li>
  
<li>The in-memory database is shut down.</li>
</ol>

<blockquote>
<p>Enough overviews.</p>
</blockquote>
<p><a href="standard_example.html">An example</a> could be the best way to illustrate the use of the Nazgul persistence test framework. </p></div>
<div class="section">
<h2><a name="Persistence_test_structure"></a>Persistence test structure</h2>
<p>While the classes of the Nazgul Core: Persistence Test component hides some fairly complex underpinnings, there are relatively few classes involved. The image below illustrates the static aspects of the component: </p>
<p><img src="images/persistenceTestTypes.jpg" style="margin:10px; border:1px solid black;" width="71%" height="71%" alt="" /></p>

<ol style="list-style-type: decimal">
  
<li>The AbstractJpaTest class holds mechanics for automating JPA tests. As such, it creates a simplified view  to the EntityManager, called <tt>JpaPersistenceTestOperations</tt> and exposes it as a variable called <tt>jpa</tt>.  Moreover, the AbstractJpaTest class also creates a custom ClassLoader which simply means that you can use  a persistence.xml file located in a location other than the standard <tt>META-INF/persistence.xml</tt>.</li>
  
<li>The AbstractDbUnitAndJpaTest class extends the AbstractJpaTest class by adding mechanics for populating and  validating database content using the <a class="externalLink" href="http://dbunit.sourceforge.net/">dbUnit</a> framework.</li>
  
<li>Finally, the StandardPersistenceTest implements a set of standards regarding structure, placement, naming  and so on. This is also the class your automated tests should extend, as illustrated in the  <a href="standard_example.html">standard example</a>.</li>
</ol></div>
                  </div>
            </div>
          </div>

    <hr/>

    <footer>
            <div class="container-fluid">
                      <div class="row-fluid">
                                                                          
<script type="text/javascript">SyntaxHighlighter.all()</script>
                          </div>

        
                </div>
    </footer>
        </body>
</html>
