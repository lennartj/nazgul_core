<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia at 2016-07-01 
 | Rendered using Apache Maven Fluido Skin 1.4
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20160701" />
    <meta http-equiv="Content-Language" content="en" />
    <title>Nazgul Tools &#x2013; Overview: Messaging Test</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-1.4.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />

      
    <script type="text/javascript" src="./js/apache-maven-fluido-1.4.min.js"></script>

                          
        
<link rel="stylesheet" href="http://alexgorbatchev.com/pub/sh/current/styles/shThemeDefault.css" type="text/css"/>
                      
        
<link rel="stylesheet" href="http://alexgorbatchev.com/pub/sh/current/styles/shCore.css" type="text/css"/>
                      
        
<script src="http://alexgorbatchev.com/pub/sh/current/scripts/shCore.js" type="text/javascript"></script>
                      
        
<script src="http://alexgorbatchev.com/pub/sh/current/scripts/shBrushJava.js" type="text/javascript"></script>
                      
        
<script src="http://alexgorbatchev.com/pub/sh/current/scripts/shBrushJScript.js" type="text/javascript"></script>
                      
        
<script src="http://alexgorbatchev.com/pub/sh/current/scripts/shBrushXml.js" type="text/javascript"></script>
          
                  </head>
        <body class="topBarDisabled">
          
                
                    
    
        <div class="container-fluid">
          <div id="banner">
        <div class="pull-left">
                                <div id="bannerLeft">
                <h2>nazgul-core-messaging-test</h2>
                </div>
                      </div>
        <div class="pull-right">              <div id="bannerRight">
                <h2>Nazgul Framework: Core</h2>
                </div>
      </div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
                
                    
                  <li id="projectVersion">Version: 1.9.0
                    </li>
              
                
                    
                  <li id="publishDate" class="pull-right"><span class="divider">|</span> Last Published: 2016-07-01</li>
            
                                    
    <li class="pull-right">
        <span class="divider">|</span>
                      <a href="http://bitbucket.org/lennartj" class="externalLink" title="Bitbucket">
        Bitbucket</a>
      </li>

  
    <li class="pull-right">
                      <a href="http://maven.apache.org/" class="externalLink" title="Maven">
        Maven</a>
      </li>

                    </ul>
      </div>

            
      <div class="row-fluid">
        <div id="leftColumn" class="span2">
          <div class="well sidebar-nav">
                
                    
                <ul class="nav nav-list">
                    <li class="nav-header">Overview</li>
                              
      <li class="active">
  
            <a href="#"><span class="none"></span>Introduction</a>
          </li>
                              <li class="nav-header">Parent Project</li>
                              
      <li>
  
                          <a href="../../core/poms/core-parent/index.html" title="nazgul-core-parent">
          <span class="none"></span>
        nazgul-core-parent</a>
            </li>
                                                            <li class="nav-header">Project Documentation</li>
                                                                                                                                                                                                                                                                                      
      <li>
  
                          <a href="project-info.html" title="Project Information">
          <span class="icon-chevron-right"></span>
        Project Information</a>
                  </li>
                                                                                                                                                                                                                                                                
      <li>
  
                          <a href="project-reports.html" title="Project Reports">
          <span class="icon-chevron-down"></span>
        Project Reports</a>
                    <ul class="nav nav-list">
                    
      <li class="active">
  
            <a href="#"><span class="none"></span>AspectJ Report</a>
          </li>
                    
      <li>
  
                          <a href="apidocs/index.html" title="JavaDocs">
          <span class="none"></span>
        JavaDocs</a>
            </li>
                    
      <li>
  
                          <a href="testapidocs/index.html" title="Test JavaDocs">
          <span class="none"></span>
        Test JavaDocs</a>
            </li>
                    
      <li>
  
                          <a href="xref/index.html" title="Source Xref">
          <span class="none"></span>
        Source Xref</a>
            </li>
                    
      <li>
  
                          <a href="xref-test/index.html" title="Test Source Xref">
          <span class="none"></span>
        Test Source Xref</a>
            </li>
                    
      <li>
  
                          <a href="cobertura/index.html" title="Cobertura Test Coverage">
          <span class="none"></span>
        Cobertura Test Coverage</a>
            </li>
                    
      <li>
  
                          <a href="findbugs.html" title="FindBugs">
          <span class="none"></span>
        FindBugs</a>
            </li>
                    
      <li>
  
                          <a href="clirr-report.html" title="Clirr">
          <span class="none"></span>
        Clirr</a>
            </li>
                    
      <li>
  
                          <a href="property-updates-report.html" title="Property Updates Report">
          <span class="none"></span>
        Property Updates Report</a>
            </li>
                    
      <li>
  
                          <a href="dependency-updates-report.html" title="Dependency Updates Report">
          <span class="none"></span>
        Dependency Updates Report</a>
            </li>
                    
      <li>
  
                          <a href="plugin-updates-report.html" title="Plugin Updates Report">
          <span class="none"></span>
        Plugin Updates Report</a>
            </li>
              </ul>
        </li>
            </ul>
                
                    
                
          <hr />

           <div id="poweredBy">
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="builtBy" alt="Built by Maven" src="./images/logos/maven-feather.png" />
      </a>
                  </div>
          </div>
        </div>
        
                
        <div id="bodyColumn"  class="span10" >
                                  
            <h1>Overview: Messaging Test</h1>
<p>The Java EE Messaging specification is simple in regards to how to create and synthesize JMS messages. However, creating and sending messages require a JEE infrastructure which is far from trivial to setup. The Nazul Core: Messaging Test project provides a simple infrastructure to setup and run JMS message tests.</p>
<p>The Messaging Test component provides a main abstract superclass (called <tt>AbstractJmsTest</tt>) which contains most of the mechanics required to automatically set up a message broker, permit users to add Destination definitions and then launch each testcase. As illustrated in the image below, 2 abstract subclasses to the AbstractJmsTest exist:</p>

<ol style="list-style-type: decimal">
  
<li>The <tt>AbstractActiveMqTest</tt> is an AbstractJmsTest that wraps an in-memory  <a class="externalLink" href="http://activemq.apache.org/">Apache ActiveMQ</a> message broker.</li>
  
<li>The <tt>AbstractHornetQBroker</tt> is an AbstractJmsTest that wraps an in-memory  <a class="externalLink" href="http://www.jboss.org/hornetq">JBoss HornetQ</a> message broker.</li>
</ol>
<p>The class structure of the messaging test project is as follows:</p>
<p><img src="images/structure.png" style="border: 1px solid grey;" alt="" /></p>
<p>There is typically a standard way to setup JMS unit tests using the Messaging Test project:</p>

<ol style="list-style-type: decimal">
  
<li>Create the services, which contain the server-side JMS objects - normally  a Connection/Session/MessageProducer and MessageConsumer/MessageListener  to read requests from the client and send out responses back to it.  While trivial in themselves, these operations are typically rather boilerplate-  heavy, as illustrated in the &#x201c;Sameple setupServices() method&#x201d; code snippet  below.</li>
  
<li>Create each testcase, which contain the client-side JMS objects - normally  another set of Connection/Session/MessageProducer and MessageConsumer/MessageListener  to create/send requests to the broker for processing in the client side.  While simple, these test cases are typically also strewn with boilerplate  setup code, as illustrated in the &#x201c;Sample unit test method&#x201d; code snippet  below.</li>
</ol>
<div class="section">
<h2><a name="The_server_side:_Setting_up_services"></a>The server side: Setting up services</h2>
<p>All messaging tests require client-side logic sending messages and receiving responses, as well as server-side logic receiving client request messages and returning responses back to the client. The setupServices method is called before each unit test method, and is intended to set up the server-side logic.</p>
<p>Typically, the server side logic setup follows the code snippet below:</p>

<div>
<pre class="brush: java" title="Sample setupServices() method.">
    /**
     * {@inheritDoc}
     */
    @Override
    public void setupServices() throws JMSException {

        // This is where we set up JMS objects on the server side.
        // These objects are created before any test cases are launched.

        // 1) Get a connection to the JMS broker.
        final Connection serverSideConnection = createConnection();

        // 2) Create a server-side Session, Queue and MessageConsumer reading messages from the broker.
        final Session serverSideRequestSession = createSession(serverSideConnection);
        final Queue serviceSideInboundQueue = serverSideRequestSession.createQueue(SERVER_SIDE_INBOUND_REQUEST);
        final MessageConsumer requestMessageConsumer = serverSideRequestSession.createConsumer(serviceSideInboundQueue);

        // 3) Create a server-side Session, Queue and MessageProducer sending messages to the broker.
        final Session serverSideResponseSession = createSession(serverSideConnection);
        final Queue serviceSideOutboundQueue = serverSideResponseSession.createQueue(SERVER_SIDE_OUTBOUND_RESPONSE);
        final MessageProducer responseMessageProducer = serverSideResponseSession
                .createProducer(serviceSideOutboundQueue);
        responseMessageProducer.setDeliveryMode(DeliveryMode.NON_PERSISTENT);

        // 4) Register a MessageListener to read messages from the requestMessageConsumer
        //    and write messages to the responseMessageProducer.
        //    This completes the server-side setup.
        requestMessageConsumer.setMessageListener(new MessageListener() {
            @Override
            public void onMessage(final Message message) {

                // Stash the received message for test purposes
                serverSideReceivedMessages.add(message);

                try {

                    // Define the outbound message
                    final TextMessage toReturn = serverSideResponseSession.createTextMessage();
                    toReturn.setJMSCorrelationID(message.getJMSMessageID());

                    // This test service is designed only to properly accept incoming TextMessages.
                    if (!(message instanceof TextMessage)) {

                        // Create an error message.
                        toReturn.setText(&quot;Only text messages are handled. Received [&quot;
                                + message.getClass().getSimpleName() + &quot;]&quot;);
                    } else {

                        // Create a 'proper' response holding the body of the
                        // inbound TextMessage + some extra text.
                        final TextMessage msg = (TextMessage) message;
                        toReturn.setText(&quot;Received inbound: &quot; + msg.getText());
                    }

                    // Send the error message back to the client.
                    responseMessageProducer.send(toReturn);
                    serverSideResponseSession.commit();

                } catch (JMSException e) {
                    throw new IllegalStateException(&quot;Could not send message.&quot;, e);
                }
            }
        });
    }
</pre></div></div>
<div class="section">
<h2><a name="The_client_side:_unit_test_method_definitions"></a>The client side: unit test method definitions</h2>
<p>All messaging tests require client-side logic sending messages and receiving responses, as well as server-side logic receiving client request messages and returning responses back to the client. The setupServices method is called before each unit test method, and is intended to set up the server-side logic.</p>
<p>Typically, the client side logic setup follows the code snippet below:</p>

<div>
<pre class="brush: java" title="Sample unit test method">
    @Test
    public void validateTextMessageYieldsCorrectResponse() throws Exception {

        // Assemble
        final String clientMessage = &quot;This is a client-side originated message.&quot;;
        final List&lt;Message&gt; receivedClientResponses = new ArrayList&lt;Message&gt;();

        final Connection clientConnection = createConnection();
        final Session clientRequestSession = createSession(clientConnection);
        final Queue clientRequestQueue = clientRequestSession.createQueue(CLIENT_SIDE_OUTBOUND_REQUEST);

        final Session clientResponseSession = createSession(clientConnection);
        final Queue clientResponseQueue = clientResponseSession.createQueue(CLIENT_SIDE_INBOUND_RESPONSE);

        final MessageProducer clientRequestProducer = clientRequestSession.createProducer(clientRequestQueue);
        clientRequestProducer.setDeliveryMode(DeliveryMode.NON_PERSISTENT);

        final CountDownLatch receivedMessagesLatch = new CountDownLatch(1);

        final MessageConsumer clientResponseConsumer = clientResponseSession.createConsumer(clientResponseQueue);
        final MessageListener clientResponseListener = new MessageListener() {
            @Override
            public void onMessage(final Message message) {
                receivedClientResponses.add(message);
                receivedMessagesLatch.countDown();
            }
        };
        clientResponseConsumer.setMessageListener(clientResponseListener);

        // Act
        final TextMessage toSend = clientRequestSession.createTextMessage();
        toSend.setStringProperty(&quot;foo&quot;, &quot;bar&quot;);
        toSend.setText(clientMessage);
        clientRequestProducer.send(toSend);
        clientRequestSession.commit();

        final boolean correctlyReceivedMessage = receivedMessagesLatch.await(2, TimeUnit.SECONDS);

        // Assert
        Assert.assertTrue(correctlyReceivedMessage);
        Assert.assertEquals(1, receivedClientResponses.size());
        Assert.assertEquals(1, serverSideReceivedMessages.size());

        final TextMessage response = (TextMessage) receivedClientResponses.get(0);
        Assert.assertEquals(response.getText(), &quot;Received inbound: &quot; + clientMessage);
    }
</pre></div></div>
                  </div>
            </div>
          </div>

    <hr/>

    <footer>
            <div class="container-fluid">
                      <div class="row-fluid">
                                                                          
<script type="text/javascript">SyntaxHighlighter.all()</script>
                          </div>

        
                </div>
    </footer>
        </body>
</html>
